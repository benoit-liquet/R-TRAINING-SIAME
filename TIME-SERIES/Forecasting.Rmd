---
title: "Forecasting Times Series with R"
author: "Benoit Liquet from Michael Bar work"
date: "November, 2017"
output:
  html_document: default
  pdf_document: default
---
  ## Introduction
  In these notes we demonstrate how to forecast Time Series with R

```{r preparing}
rm(list=ls()) #rm(list of objects) removes all objects from memory
graphics.off() #Closign all previously open graphs
```

## I. Airline Example
In this example we forecast domestic airline passengers.

Loading data into R:
```{r Loading data into R}
library(foreign)
airline <- read.csv("AirlineData.csv")
```

**Data source:**
  
  U.S. Department of Transportation

Bureau of Transportation Statistics

URL: http://www.transtats.bts.gov/Data_Elements.aspx?Data=1

**Variable Description:**
  
  Year       - Year

Month      - Month

dom.pass   - number of passengers on domestic flights

int.pass   - number of passengers on international flights

total.pass - number of passengers on all flights


**Removing observations that have TOTAL in Month**
```{r cleaninig}
airline <- subset(airline, airline$Month != "TOTAL") 
```

**Need to install the forecast package**
```{r Installing "forcast"}
#install.packages("forecast") #Need to do this only once
library(forecast)
```

**Creating a time series object from dom.pass**
```{r ts object}
dom.ts <- ts(airline$dom.pass, start=c(2002, 10), frequency=12)
```

**Plotting the time series**
```{r Plotting Time Series,warning=FALSE}
plot(dom.ts, main="Time Series of Domestic Pasengers",
     type="lines", xlab="Time", ylab="# of Passengers on domestic flights",
     col="blue", lty=1, lwd=2)
grid()
```

Seems like a structural break between 2008 - 2010. There seems to be an upward trend prior to 2008. Then around 2009 there was a sharp fall, and a new trend started in 2010.

A time series with additive trend, seasonal, and irregular components can be decomposed using the stl() function from base R, or ets() function from "forecast" package.

**Decomposing with stl()**
```{r Decomposing with stl()}
fit1 <- stl(dom.ts, s.window="periodic")
library(ggplot2)
autoplot(fit1, main="Decomposition by STL method")
```

**Decomposing with ets()**
```{r Decomposing with ets()}
fit2 <- ets(dom.ts)
library(ggplot2)
autoplot(fit2)
```

**Plotting monthly variation**
```{r Monthly variation}
monthplot(dom.ts, main="Monthly Variation of Domestic Pasengers")
```

**Plotting seasonal componnent**
```{r Seasonal componnent}
seasonplot(dom.ts, main="Seasonal Variation of Domestic Pasengers") 
```

**Forecasting the time series**
```{r Forecasting}
n <- 24 #We will generate forecast for n periods into the future
f1 <- forecast(fit1,h=n) #Based on stl()
f1
f2 <- forecast(fit2,h=n) #Based on ets()
f2

```

The forecasts are very similar. We choose to plot and save the ets() forecast.

```{r Choosing ets()}
f <- f1
```

**Plotting forecasted time series**
```{r Plotting forecasted data}
plot(f, lwd=2, main="Historical and Forecasted Doemestic Passengers")
grid()
```

**Saving the forecasted data**
```{r Saving the forecasted data,eval=FALSE}
forecast_data <- data.frame(date=as.Date(time(f$mean)), p_low = as.matrix(f$lower[1:n,2]), 
                            p_mean=as.matrix(f$mean), p_upper=as.matrix(f$upper[1:n,2]))
write.csv(forecast_data, file = "forecast.csv", row.names = F) #Saves dataset in CVS format
```


